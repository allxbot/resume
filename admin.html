<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>简历双语后台 (V5 对齐同步版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        /* 全局样式 */
        body { background-color: #f1f5f9; color: #334155; height: 100vh; display: flex; flex-direction: column; }
        
        /* 输入框样式 */
        .json-input { width: 100%; padding: 0.5rem; border: 1px solid #cbd5e1; border-radius: 0.25rem; font-size: 0.875rem; background: #fff; transition: all 0.2s; }
        .json-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59,130,246,0.1); }
        textarea.json-input { min-height: 80px; line-height: 1.5; resize: vertical; }

        /* 布局网格 */
        .dual-row { display: flex; width: 100%; border-bottom: 1px solid #e2e8f0; background: #fff; }
        .dual-row:last-child { border-bottom: none; }
        .dual-row:hover { background-color: #f8fafc; }
        
        .col-left { width: 50%; padding: 1rem; border-right: 1px solid #e2e8f0; position: relative; }
        .col-right { width: 50%; padding: 1rem; position: relative; }

        /* 标签 */
        .field-label { display: block; font-size: 0.7rem; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 0.4rem; letter-spacing: 0.05em; }

        /* 数组容器 */
        .array-wrapper { margin: 1rem 0; border: 1px solid #cbd5e1; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .array-header { background: #e2e8f0; padding: 0.5rem 1rem; display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; font-weight: bold; color: #475569; }

        /* 滚动条 */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; border: 2px solid #f1f1f1; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="font-sans">

    <div class="bg-white shadow z-50 px-6 py-3 border-b border-gray-200 shrink-0">
        <div class="flex flex-col md:flex-row justify-between items-center max-w-[1920px] mx-auto gap-4">
            <h1 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                <i class="fa fa-columns text-blue-600"></i> 双语后台 <span class="text-xs bg-blue-100 text-blue-700 px-2 rounded">V5 Sync</span>
            </h1>
            
            <div class="flex items-center gap-2 text-sm bg-yellow-50 px-3 py-1 rounded text-yellow-800 border border-yellow-200" title="在此模式下，两边结构强制锁定，确保高度对齐">
                <i class="fa fa-lock"></i>
                <span class="font-bold text-xs">结构同步锁定 (Structure Locked)</span>
            </div>

            <div class="flex flex-wrap gap-2 items-center">
                <input id="gh_owner" type="text" placeholder="GitHub User" class="border border-gray-300 p-1.5 rounded text-sm w-28 focus:border-blue-500 outline-none">
                <input id="gh_repo" type="text" placeholder="Repo Name" class="border border-gray-300 p-1.5 rounded text-sm w-28 focus:border-blue-500 outline-none">
                <input id="gh_token" type="password" placeholder="Token" class="border border-gray-300 p-1.5 rounded text-sm w-32 focus:border-blue-500 outline-none">
                
                <button id="btn-load" class="bg-slate-700 text-white px-4 py-1.5 rounded text-sm hover:bg-slate-800 transition flex items-center gap-2 shadow-sm cursor-pointer">
                    <i class="fa fa-refresh"></i> 读取
                </button>
                <button id="btn-save" class="bg-green-600 text-white px-5 py-1.5 rounded text-sm font-bold hover:bg-green-700 transition shadow-sm flex items-center gap-2 cursor-pointer">
                    <i class="fa fa-floppy-o"></i> 保存
                </button>
            </div>
        </div>
        <div id="status-bar" class="text-center text-xs mt-1 font-mono h-4 text-transparent transition-colors duration-300">Ready</div>
    </div>

    <div class="flex w-full max-w-[1920px] mx-auto bg-gray-50 border-b border-gray-200 shrink-0 text-sm font-bold text-gray-600">
        <div class="w-1/2 px-6 py-2 border-r border-gray-200 flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-blue-500"></span> 中文 (Chinese)
        </div>
        <div class="w-1/2 px-6 py-2 flex items-center gap-2">
            <span class="w-2 h-2 rounded-full bg-purple-500"></span> 英文 (English)
        </div>
    </div>

    <div class="flex-1 overflow-y-auto bg-gray-100 scroll-smooth">
        <div class="max-w-[1920px] mx-auto bg-white shadow-sm min-h-full pb-32" id="editor-root">
            <div class="flex flex-col items-center justify-center h-96 text-gray-400">
                <i class="fa fa-cloud-download text-5xl mb-4 opacity-30"></i>
                <p>请配置 GitHub 信息并点击“读取”</p>
            </div>
        </div>
    </div>

    <script>
        // --- Global State ---
        let appData = {};
        let fileSha = "";
        const STORAGE_KEYS = ['gh_owner', 'gh_repo', 'gh_token'];

        // Icons
        const ICON_LIST = ["", "fa-cogs", "fa-user", "fa-briefcase", "fa-graduation-cap", "fa-wrench", "fa-leaf", "fa-line-chart", "fa-users", "fa-flask", "fa-tasks", "fa-heart", "fa-star", "fa-check", "fa-envelope", "fa-phone", "fa-linkedin", "fa-github", "fa-wechat", "fa-facebook", "fa-sitemap", "fa-file-text-o", "fa-calendar", "fa-map-marker"];

        // --- Initialization ---
        window.onload = function() {
            STORAGE_KEYS.forEach(k => {
                const v = localStorage.getItem(k);
                if(v) document.getElementById(k).value = v;
            });
            document.getElementById('btn-load').addEventListener('click', initLoad);
            document.getElementById('btn-save').addEventListener('click', commitChanges);
        };

        // --- 1. Load Data ---
        async function initLoad() {
            const owner = document.getElementById('gh_owner').value.trim();
            const repo = document.getElementById('gh_repo').value.trim();
            const token = document.getElementById('gh_token').value.trim();

            if(owner) localStorage.setItem('gh_owner', owner);
            if(repo) localStorage.setItem('gh_repo', repo);
            if(token) localStorage.setItem('gh_token', token);

            updateStatus("Connecting...", "text-blue-600");
            setLoading(true);

            try {
                let jsonContent = "";
                if (owner && repo && token) {
                    const url = `https://api.github.com/repos/${owner}/${repo}/contents/data.json?t=${Date.now()}`;
                    const res = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
                    if (!res.ok) throw new Error(`API Error ${res.status}`);
                    const data = await res.json();
                    fileSha = data.sha;
                    jsonContent = decodeURIComponent(escape(window.atob(data.content.replace(/\n/g, ""))));
                    updateStatus("✅ Loaded from GitHub", "text-green-600 font-bold");
                } else {
                    const res = await fetch('./data.json');
                    if(!res.ok) throw new Error("Local file not found");
                    jsonContent = await res.text();
                    fileSha = "";
                    updateStatus("⚠️ Preview Mode (Local)", "text-orange-500 font-bold");
                }

                appData = JSON.parse(jsonContent);
                if(!appData.zh) appData.zh = {};
                if(!appData.en) appData.en = {};

                renderUI();
            } catch (e) {
                console.error(e);
                updateStatus(`❌ Error: ${e.message}`, "text-red-600 font-bold");
                alert(e.message);
            } finally {
                setLoading(false);
            }
        }

        // --- 2. Render UI (The V5 Logic) ---
        function renderUI() {
            const root = document.getElementById('editor-root');
            root.innerHTML = '';
            
            // 我们不分别渲染两棵树，而是调用“双路渲染器”
            // 它会同时遍历 ZH 和 EN 对象，生成对齐的行
            root.appendChild(renderDualRecursive(appData.zh, appData.en, []));
        }

        // --- 3. Dual Recursive Renderer (The Magic) ---
        // 同时接收 zhData 和 enData，生成一个 DOM 节点
        function renderDualRecursive(zhData, enData, path) {
            const container = document.createElement('div');
            container.className = "w-full";

            // Case A: 数组 (Array)
            // 假设 zhData 和 enData 都是数组 (或者其中一个是 undefined)
            if (Array.isArray(zhData) || Array.isArray(enData)) {
                const zhArr = Array.isArray(zhData) ? zhData : [];
                const enArr = Array.isArray(enData) ? enData : [];
                
                // 取最大长度，确保显示所有项
                const maxLen = Math.max(zhArr.length, enArr.length);

                for (let i = 0; i < maxLen; i++) {
                    const wrapper = document.createElement('div');
                    wrapper.className = "array-wrapper mx-4";
                    
                    // 数组项 Header (横跨整行)
                    const header = document.createElement('div');
                    header.className = "array-header";
                    header.innerHTML = `<span>ITEM #${i + 1}</span>`;
                    
                    const delBtn = document.createElement('button');
                    delBtn.className = "text-red-500 hover:text-red-700 hover:bg-red-50 px-2 rounded transition";
                    delBtn.innerHTML = '<i class="fa fa-trash"></i> 删除 (Delete)';
                    delBtn.onclick = () => {
                        if(confirm('确定删除此项吗? (Delete this item?)')) {
                            modifyDualArray('delete', path, i);
                        }
                    };
                    header.appendChild(delBtn);
                    wrapper.appendChild(header);

                    // 递归渲染内部内容 (zhArr[i] vs enArr[i])
                    // 这里不需要 padding，因为内部的 renderDualRecursive 会生成 dual-row
                    const contentBox = document.createElement('div');
                    contentBox.appendChild(renderDualRecursive(zhArr[i], enArr[i], [...path, i]));
                    
                    wrapper.appendChild(contentBox);
                    container.appendChild(wrapper);
                }

                // 添加按钮 (横跨整行)
                const addRow = document.createElement('div');
                addRow.className = "p-4 flex justify-center border-b border-dashed border-gray-300";
                const addBtn = document.createElement('button');
                addBtn.className = "bg-blue-50 text-blue-600 border border-blue-200 px-6 py-2 rounded-full text-sm font-bold hover:bg-blue-100 transition shadow-sm";
                addBtn.innerHTML = '<i class="fa fa-plus-circle"></i> 添加新项 (Add New Item)';
                addBtn.onclick = () => modifyDualArray('add', path);
                addRow.appendChild(addBtn);
                container.appendChild(addRow);
            }

            // Case B: 对象 (Object)
            else if (isObject(zhData) || isObject(enData)) {
                const zhObj = isObject(zhData) ? zhData : {};
                const enObj = isObject(enData) ? enData : {};
                
                // 获取所有 Key 的并集
                const keys = new Set([...Object.keys(zhObj), ...Object.keys(enObj)]);
                
                keys.forEach(key => {
                    // 1. 如果子项是深层结构（对象或数组），渲染为标题区域
                    const isComplex = isComplexStructure(zhObj[key]) || isComplexStructure(enObj[key]);
                    
                    if (isComplex) {
                        const titleRow = document.createElement('div');
                        titleRow.className = "bg-gray-100 p-2 font-bold text-xs text-gray-500 uppercase tracking-widest border-b border-t border-gray-200 text-center mt-2";
                        titleRow.innerText = formatKey(key);
                        container.appendChild(titleRow);
                        
                        container.appendChild(renderDualRecursive(zhObj[key], enObj[key], [...path, key]));
                    } 
                    // 2. 如果是基础值，渲染为左右对照行
                    else {
                        const row = document.createElement('div');
                        row.className = "dual-row";

                        // 左侧 (ZH)
                        const leftCol = document.createElement('div');
                        leftCol.className = "col-left";
                        leftCol.appendChild(createLabel(key));
                        leftCol.appendChild(createInput(zhObj[key], [...path, key], 'zh')); // 标记源是 zh
                        row.appendChild(leftCol);

                        // 右侧 (EN)
                        const rightCol = document.createElement('div');
                        rightCol.className = "col-right";
                        rightCol.appendChild(createLabel(key));
                        rightCol.appendChild(createInput(enObj[key], [...path, key], 'en')); // 标记源是 en
                        row.appendChild(rightCol);

                        container.appendChild(row);
                    }
                });
            }
            
            // Case C: 基础值混入 (Fallback)
            // 通常不会直接走到这，除非结构定义不规范，忽略即可
            
            return container;
        }

        // --- 4. Input Generators ---
        function createLabel(text) {
            const label = document.createElement('label');
            label.className = "field-label";
            label.innerText = formatKey(text);
            return label;
        }

        function createInput(value, path, lang) {
            const rawKey = path[path.length - 1];
            const keyStr = String(rawKey).toLowerCase();
            let input;

            // Type 1: Icon Select
            if (keyStr === 'icon') {
                input = document.createElement('select');
                input.className = "json-input cursor-pointer bg-gray-50";
                ICON_LIST.forEach(ic => {
                    const opt = document.createElement('option');
                    opt.value = ic;
                    opt.text = ic || "No Icon";
                    if (value === ic) opt.selected = true;
                    input.appendChild(opt);
                });
            } 
            // Type 2: Textarea
            else if (typeof value === 'string' && (value.length > 40 || ['desc', 'summary', 'items', 'list', 'details'].some(k => keyStr.includes(k)))) {
                input = document.createElement('textarea');
                input.className = "json-input";
                input.value = value || "";
            }
            // Type 3: Standard Input
            else {
                input = document.createElement('input');
                input.type = typeof value === 'number' ? 'number' : 'text';
                input.className = "json-input";
                input.value = (value === undefined || value === null) ? "" : value;
            }

            // Bind Change Event
            input.onchange = (e) => {
                let val = e.target.value;
                if (typeof value === 'number') val = Number(val);
                
                // Update Global Data
                // 注意：这里我们需要根据 lang 决定去更新 appData.zh 还是 appData.en
                // path 现在的结构是 [key1, key2...] (不包含 'zh'/'en' 前缀)
                // 所以我们需要构造完整路径
                const fullPath = [lang, ...path];
                updateDataByPath(fullPath, val);
            };

            return input;
        }

        // --- 5. Logic: Array Sync Add/Delete ---
        function modifyDualArray(action, path, idx) {
            // 对 appData.zh 和 appData.en 同时操作
            const zhTarget = getTarget(appData.zh, path);
            const enTarget = getTarget(appData.en, path);

            // 必须确保两边都是数组，如果有一边是 undefined，先初始化为 []
            if(!Array.isArray(zhTarget)) setTarget(appData.zh, path, []);
            if(!Array.isArray(enTarget)) setTarget(appData.en, path, []);
            
            const zhArr = getTarget(appData.zh, path);
            const enArr = getTarget(appData.en, path);

            if (action === 'delete') {
                if (zhArr[idx] !== undefined) zhArr.splice(idx, 1);
                if (enArr[idx] !== undefined) enArr.splice(idx, 1);
            } 
            else if (action === 'add') {
                // Template Cloning (From ZH side preference)
                let tpl = {};
                if (zhArr.length > 0) tpl = cloneClean(zhArr[0]);
                else if (enArr.length > 0) tpl = cloneClean(enArr[0]);
                else tpl = { title: "New Item", desc: "" }; // Fallback

                zhArr.push(JSON.parse(JSON.stringify(tpl)));
                enArr.push(JSON.parse(JSON.stringify(tpl)));
            }

            renderUI(); // Re-render complete tree
        }

        // --- 6. Saving ---
        async function commitChanges() {
            if (!fileSha) return alert("Please load data first.");
            updateStatus("Saving...", "text-blue-600");
            setLoading(true);
            
            try {
                const owner = document.getElementById('gh_owner').value;
                const repo = document.getElementById('gh_repo').value;
                const token = document.getElementById('gh_token').value;
                
                const content = window.btoa(unescape(encodeURIComponent(JSON.stringify(appData, null, 2))));
                const body = {
                    message: "Update via Admin V5 Sync",
                    content: content,
                    sha: fileSha
                };
                
                const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/data.json`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                if(!res.ok) throw new Error((await res.json()).message);
                
                const json = await res.json();
                fileSha = json.content.sha;
                updateStatus("✅ Saved Successfully", "text-green-600 font-bold");
                alert("Saved!");
            } catch(e) {
                alert(e.message);
                updateStatus("❌ Save Failed", "text-red-600");
            } finally {
                setLoading(false);
            }
        }

        // --- Helpers ---
        function getTarget(root, path) {
            let t = root;
            for(let k of path) {
                if(t[k] === undefined) return undefined;
                t = t[k];
            }
            return t;
        }

        function setTarget(root, path, val) {
            let t = root;
            for(let i=0; i<path.length-1; i++) {
                if(!t[path[i]]) t[path[i]] = {}; // Auto-create path
                t = t[path[i]];
            }
            t[path[path.length-1]] = val;
        }

        function updateDataByPath(fullPath, val) {
            let t = appData;
            for(let i=0; i<fullPath.length-1; i++) t = t[fullPath[i]];
            t[fullPath[fullPath.length-1]] = val;
        }

        function isObject(v) { return typeof v === 'object' && v !== null && !Array.isArray(v); }
        function isComplexStructure(v) { return typeof v === 'object' && v !== null; }
        
        function cloneClean(obj) {
            if (typeof obj !== 'object' || obj === null) return obj;
            const newObj = Array.isArray(obj) ? [] : {};
            Object.keys(obj).forEach(k => {
                if(typeof obj[k] === 'string') newObj[k] = "";
                else if(typeof obj[k] === 'number') newObj[k] = 0;
                else newObj[k] = cloneClean(obj[k]);
            });
            return newObj;
        }

        function formatKey(k) { return String(k).replace(/_/g, ' '); }
        function updateStatus(msg, cls) { 
            const el = document.getElementById('status-bar'); 
            el.textContent = msg; 
            el.className = `text-center text-xs mt-1 font-mono h-4 transition-all ${cls}`;
            if(!cls.includes('red')) setTimeout(()=>el.textContent="Ready", 4000);
        }
        function setLoading(b) {
            document.getElementById('btn-load').disabled = b;
            document.getElementById('btn-save').disabled = b;
            document.body.style.cursor = b ? 'wait' : 'default';
        }
    </script>
</body>
</html>
