<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resume CMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        .json-editor-input { width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; font-size: 0.875rem; transition: all 0.2s; }
        .json-editor-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        .array-group { border: 1px dashed #cbd5e1; background-color: #f8fafc; padding: 1rem; border-radius: 0.5rem; position: relative; margin-bottom: 1rem; }
        .field-label { display: block; font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 0.25rem; }
        .delete-btn { position: absolute; top: 0.5rem; right: 0.5rem; color: #ef4444; opacity: 0.6; cursor: pointer; }
        .delete-btn:hover { opacity: 1; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div class="fixed top-0 w-full bg-white shadow-sm z-50 px-6 py-3 border-b flex justify-between items-center">
        <h1 class="font-bold text-gray-800"><i class="fa fa-edit text-blue-600"></i> Resume Admin</h1>
        <div class="flex gap-3">
             <input id="gh_token" type="password" placeholder="GitHub Token (Required)" class="border p-1.5 rounded text-sm w-64">
             <button onclick="loadData()" class="bg-blue-600 text-white px-4 py-1.5 rounded text-sm font-medium hover:bg-blue-700">Load Data</button>
             <button onclick="saveToGitHub()" class="bg-green-600 text-white px-4 py-1.5 rounded text-sm font-medium hover:bg-green-700">Save Changes</button>
        </div>
        <div class="hidden">
            <input id="gh_owner" value=""> <input id="gh_repo" value="">
        </div>
    </div>

    <div class="max-w-7xl mx-auto mt-20 px-4 flex gap-8 pb-20">
        <div class="w-64 shrink-0">
            <div class="sticky top-24 space-y-4">
                <div class="bg-white p-4 rounded shadow-sm">
                    <h3 class="field-label mb-3">Language</h3>
                    <div class="space-y-1">
                        <button onclick="switchLang('zh')" id="btn-zh" class="w-full text-left px-3 py-2 rounded text-sm font-medium bg-blue-50 text-blue-600 border-l-4 border-blue-600">Chinese (中文)</button>
                        <button onclick="switchLang('en')" id="btn-en" class="w-full text-left px-3 py-2 rounded text-sm font-medium text-gray-600 hover:bg-gray-50 border-l-4 border-transparent">English</button>
                    </div>
                </div>
                <div class="text-xs text-gray-400 px-2">
                    Tip: 输入 "fa-user" 等图标名可自动预览。数组项点击底部 "Add" 按钮新增。
                </div>
            </div>
        </div>

        <div class="flex-1 bg-white p-8 rounded shadow-sm min-h-[500px]" id="editor-container">
            <div class="flex items-center justify-center h-full text-gray-400">Please enter Token and click "Load Data"</div>
        </div>
    </div>

    <script>
        let fullData = {};
        let sha = "";
        let currentLang = 'zh';

        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('gh_owner').value = localStorage.getItem('gh_owner') || '';
             document.getElementById('gh_repo').value = localStorage.getItem('gh_repo') || '';
             document.getElementById('gh_token').value = localStorage.getItem('gh_token') || '';
        });

        async function loadData() {
            const token = document.getElementById('gh_token').value;
            const owner = localStorage.getItem('gh_owner'); // 假设之前已经存过，或者你可以加 Input
            const repo = localStorage.getItem('gh_repo');
            
            // 简单处理：如果本地有 input 则保存
            if(token) localStorage.setItem('gh_token', token);

            try {
                // 这里为了演示，假设直接 fetch 本地，真实环境请用 GitHub API
                // const url = `https://api.github.com/repos/${owner}/${repo}/contents/data.json`;
                // const res = await fetch(url, { headers: { Authorization: `token ${token}` } });
                // const data = await res.json();
                // sha = data.sha;
                // fullData = JSON.parse(decodeURIComponent(escape(window.atob(data.content.replace(/\n/g, "")))));
                
                // 模拟加载本地
                if(!fullData.zh) {
                    const res = await fetch('./data.json');
                    fullData = await res.json();
                }

                renderForm();
            } catch(e) { alert("Load Failed: " + e.message); }
        }

        function switchLang(lang) {
            currentLang = lang;
            document.querySelectorAll('button[id^="btn-"]').forEach(b => b.className = "w-full text-left px-3 py-2 rounded text-sm font-medium text-gray-600 hover:bg-gray-50 border-l-4 border-transparent");
            document.getElementById(`btn-${lang}`).className = "w-full text-left px-3 py-2 rounded text-sm font-medium bg-blue-50 text-blue-600 border-l-4 border-blue-600";
            renderForm();
        }

        function renderForm() {
            const container = document.getElementById('editor-container');
            container.innerHTML = '';
            if(!fullData[currentLang]) return;
            container.appendChild(buildRecursive(fullData[currentLang], [currentLang]));
        }

        function buildRecursive(data, path) {
            const wrapper = document.createElement('div');
            wrapper.className = "space-y-4";

            if (Array.isArray(data)) {
                // 数组处理
                data.forEach((item, idx) => {
                    const group = document.createElement('div');
                    group.className = "array-group";
                    
                    const header = document.createElement('div');
                    header.className = "flex justify-between items-center mb-2";
                    header.innerHTML = `<span class="text-xs font-bold text-blue-500">ITEM #${idx+1}</span>`;
                    
                    const del = document.createElement('button');
                    del.className = "text-red-500 hover:text-red-700 text-xs";
                    del.innerHTML = '<i class="fa fa-trash"></i> Remove';
                    del.onclick = () => { data.splice(idx, 1); renderForm(); };
                    
                    header.appendChild(del);
                    group.appendChild(header);
                    group.appendChild(buildRecursive(item, [...path, idx]));
                    wrapper.appendChild(group);
                });
                
                const addBtn = document.createElement('button');
                addBtn.className = "w-full py-2 border-2 border-dashed border-gray-300 rounded text-gray-500 hover:border-blue-500 hover:text-blue-500 font-medium text-sm transition";
                addBtn.innerText = "+ Add New Item";
                addBtn.onclick = () => {
                    // 复制第一个元素结构，或创建空对象
                    const template = data.length ? JSON.parse(JSON.stringify(data[0])) : {};
                    cleanObj(template);
                    data.push(template);
                    renderForm();
                };
                wrapper.appendChild(addBtn);

            } else if (typeof data === 'object' && data !== null) {
                // 对象处理
                Object.keys(data).forEach(key => {
                    const fieldDiv = document.createElement('div');
                    
                    // 如果是对象容器，加个标题
                    if(typeof data[key] === 'object' && data[key] !== null) {
                        const title = document.createElement('h4');
                        title.className = "font-bold text-gray-800 border-b pb-1 mb-2 mt-4 capitalize";
                        title.innerText = key.replace(/_/g, ' ');
                        fieldDiv.appendChild(title);
                        fieldDiv.className = "pl-2"; // 缩进
                    } else {
                        const label = document.createElement('label');
                        label.className = "field-label";
                        label.innerText = key.replace(/_/g, ' ');
                        fieldDiv.appendChild(label);
                    }
                    
                    fieldDiv.appendChild(buildRecursive(data[key], [...path, key]));
                    wrapper.appendChild(fieldDiv);
                });
            } else {
                // 基础值处理 (String, Number)
                const input = document.createElement(data.length > 60 ? 'textarea' : 'input');
                input.className = "json-editor-input";
                if(input.tagName === 'TEXTAREA') input.rows = 4;
                input.value = data;
                input.onchange = (e) => {
                    let val = e.target.value;
                    if(typeof data === 'number') val = Number(val);
                    updateData(path, val);
                };
                wrapper.appendChild(input);
            }
            return wrapper;
        }

        function updateData(path, val) {
            let obj = fullData;
            for(let i=0; i<path.length-1; i++) obj = obj[path[i]];
            obj[path[path.length-1]] = val;
        }

        function cleanObj(obj) {
            if(typeof obj !== 'object' || obj === null) return;
            Object.keys(obj).forEach(k => {
                if(typeof obj[k] === 'string') obj[k] = "";
                else if(typeof obj[k] === 'number') obj[k] = 0;
                else if(Array.isArray(obj[k])) obj[k] = [];
                else cleanObj(obj[k]);
            });
        }
        
        async function saveToGitHub() {
            // 这里的逻辑和之前一样，调用 GitHub API PUT data.json
            alert("Save logic triggered (check console/code for API details)");
        }
    </script>
</body>
</html>
