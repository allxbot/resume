<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub 简历后台管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
    <div class="fixed top-0 left-0 w-full bg-white shadow-sm z-50 px-6 py-4">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="text-xl font-bold text-gray-800">简历后台 (GitHub Pages 版)</h1>
            <div class="flex gap-2">
                <a href="./index.html" target="_blank" class="text-blue-600 hover:underline flex items-center text-sm">
                    预览页面 <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                </a>
                <button onclick="saveToGitHub()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors flex items-center gap-2 text-sm">
                    <span id="saveIcon">☁️</span> 提交更新到 GitHub
                </button>
            </div>
        </div>
        
        <div class="mt-4 p-4 bg-gray-50 border border-gray-200 rounded text-sm grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-gray-500 mb-1">GitHub 用户名</label>
                <input type="text" id="gh_owner" placeholder="例如: xuyongzhi" class="w-full border p-2 rounded">
            </div>
            <div>
                <label class="block text-gray-500 mb-1">仓库名称</label>
                <input type="text" id="gh_repo" placeholder="例如: resume" class="w-full border p-2 rounded">
            </div>
            <div>
                <label class="block text-gray-500 mb-1">Personal Access Token (PAT)</label>
                <input type="password" id="gh_token" placeholder="ghp_xxxx..." class="w-full border p-2 rounded">
            </div>
        </div>
        <div class="mt-2 text-xs text-red-500 text-center">* 为了安全，Token 仅保存在您的浏览器缓存中，不会发送给第三方。请确保 Token 勾选了 'repo' 权限。</div>
    </div>

    <div class="container mx-auto mt-64 px-4 pb-20 max-w-5xl">
        <div id="statusMsg" class="text-center mb-4 text-gray-600 font-medium"></div>
        <div id="editor-container" class="space-y-6">
            <div class="text-center py-10 text-gray-500">
                <button onclick="loadData()" class="bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600 transition-colors">
                    点击加载数据
                </button>
            </div>
        </div>
    </div>

    <script>
        let fullData = {};
        let sha = ""; // GitHub API 更新文件需要提供文件的 SHA 指纹

        // 页面加载时恢复配置
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('gh_owner').value = localStorage.getItem('gh_owner') || '';
            document.getElementById('gh_repo').value = localStorage.getItem('gh_repo') || '';
            document.getElementById('gh_token').value = localStorage.getItem('gh_token') || '';
        });

        // 1. 加载数据 (优先尝试 GitHub API 获取最新 SHA，失败则加载本地 JSON)
        async function loadData() {
            const owner = document.getElementById('gh_owner').value;
            const repo = document.getElementById('gh_repo').value;
            const token = document.getElementById('gh_token').value;

            // 保存配置到本地
            localStorage.setItem('gh_owner', owner);
            localStorage.setItem('gh_repo', repo);
            localStorage.setItem('gh_token', token);

            const status = document.getElementById('statusMsg');
            status.textContent = "正在读取数据...";
            status.className = "text-center mb-4 text-blue-600 font-medium";

            // 如果配置了 Token，尝试从 API 获取以拿到 SHA
            if (owner && repo && token) {
                const url = `https://api.github.com/repos/${owner}/${repo}/contents/data.json`;
                try {
                    const response = await fetch(url, { 
                        headers: { 'Authorization': `token ${token}` },
                        cache: 'no-store' 
                    });
                    
                    if (!response.ok) throw new Error('GitHub API 请求失败: ' + response.status);
                    
                    const data = await response.json();
                    sha = data.sha; 
                    
                    // 解码 Base64 (支持中文 UTF-8)
                    const content = decodeURIComponent(escape(window.atob(data.content.replace(/\n/g, ""))));
                    fullData = JSON.parse(content);
                    
                    renderEditor();
                    status.textContent = "已加载 GitHub 最新数据 (Ready to Edit)";
                    status.className = "text-center mb-4 text-green-600 font-medium";
                    return;
                } catch (e) {
                    console.warn("API 加载失败，尝试本地加载", e);
                }
            }

            // 降级方案：直接读取本地文件 (仅供预览，无法保存回 GitHub，因为没有 SHA)
            try {
                const localRes = await fetch('./data.json');
                fullData = await localRes.json();
                renderEditor();
                status.textContent = "注意：当前加载的是静态缓存数据 (未连接 GitHub API)，无法保存修改。请检查上方的 Token 配置。";
                status.className = "text-center mb-4 text-orange-600 font-bold";
            } catch (e) {
                status.textContent = "加载失败，请检查网络或配置。";
                status.className = "text-center mb-4 text-red-600 font-bold";
            }
        }

        // 2. 渲染编辑器
        function renderEditor() {
            const container = document.getElementById('editor-container');
            container.innerHTML = '';
            
            if (!fullData.zh) return;

            const zhKeys = Object.keys(fullData.zh);

            zhKeys.forEach(key => {
                const card = document.createElement('div');
                card.className = "bg-white p-6 rounded-lg shadow-sm border border-gray-200 hover:border-blue-300 transition-colors";
                
                const title = document.createElement('div');
                title.className = "text-xs font-mono text-gray-400 mb-3 uppercase tracking-wider";
                title.textContent = `Field Key: ${key}`;
                card.appendChild(title);

                const grid = document.createElement('div');
                grid.className = "grid md:grid-cols-2 gap-6";

                // 中文
                const zhGroup = document.createElement('div');
                zhGroup.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700 mb-1">中文 (ZH)</label>
                    <textarea class="w-full p-3 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm" 
                        rows="${(fullData.zh[key]||'').length > 50 ? 4 : 2}" onchange="updateField('zh', '${key}', this.value)">${fullData.zh[key] || ''}</textarea>
                `;

                // 英文
                const enGroup = document.createElement('div');
                enGroup.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700 mb-1">英文 (EN)</label>
                    <textarea class="w-full p-3 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-gray-50" 
                        rows="${(fullData.en[key]||'').length > 50 ? 4 : 2}" onchange="updateField('en', '${key}', this.value)">${fullData.en[key] || ''}</textarea>
                `;

                grid.appendChild(zhGroup);
                grid.appendChild(enGroup);
                card.appendChild(grid);
                container.appendChild(card);
            });
        }

        function updateField(lang, key, value) {
            if (!fullData[lang]) fullData[lang] = {};
            fullData[lang][key] = value;
        }

        // 3. 保存回 GitHub
        async function saveToGitHub() {
            const owner = document.getElementById('gh_owner').value;
            const repo = document.getElementById('gh_repo').value;
            const token = document.getElementById('gh_token').value;
            const status = document.getElementById('statusMsg');

            if (!token || !owner || !repo) {
                alert('保存必须填写完整的 GitHub 配置（用户名、仓库名、Token）！');
                return;
            }
            if (!sha) {
                alert('未获取到文件 SHA，请先点击“加载数据”并确保 API 连接成功。');
                return;
            }

            const btn = document.querySelector('button[onclick="saveToGitHub()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '⏳ 正在提交...';
            btn.disabled = true;

            // 编码 Base64 (支持中文 UTF-8)
            const contentString = JSON.stringify(fullData, null, 2);
            const contentBase64 = window.btoa(unescape(encodeURIComponent(contentString)));

            const url = `https://api.github.com/repos/${owner}/${repo}/contents/data.json`;

            const body = {
                message: "Update resume content via Admin Panel",
                content: contentBase64,
                sha: sha
            };

            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (response.ok) {
                    const resData = await response.json();
                    sha = resData.content.sha; // 更新 SHA
                    btn.innerHTML = '✅ 更新成功';
                    status.textContent = "更新成功！GitHub Pages 重新部署通常需要 1-2 分钟，请稍后刷新简历页面。";
                    status.className = "text-center mb-4 text-green-600 font-bold";
                } else {
                    const err = await response.json();
                    throw new Error(err.message);
                }
            } catch (error) {
                alert('保存失败: ' + error.message);
                status.textContent = "保存失败: " + error.message;
                status.className = "text-center mb-4 text-red-600 font-bold";
            } finally {
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 3000);
            }
        }
    </script>
</body>
</html>
