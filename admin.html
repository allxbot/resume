<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€å†åŒè¯­åå° (V12 å·¥å…·æ ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <style>
        /* --- æ ¸å¿ƒæ ·å¼ --- */
        body { background-color: #f8fafc; color: #334155; height: 100vh; display: flex; flex-direction: column; font-family: 'Segoe UI', Roboto, sans-serif; padding-bottom: 80px; /* ä¸ºåº•éƒ¨å·¥å…·æ ç•™ç©ºé—´ */ }
        
        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* è¾“å…¥æ¡† */
        .json-input { width: 100%; padding: 8px 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; background: #fff; transition: all 0.2s; line-height: 1.5; }
        .json-input:focus { outline: none; border-color: #3b82f6; ring: 2px; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

        /* æ‚¬æµ®å·¥å…·æ  */
        #toolbar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 8px 16px;
            border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            gap: 8px;
            z-index: 1000;
            border: 1px solid #e2e8f0;
            align-items: center;
        }

        .tool-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .tool-btn:hover { background-color: #f1f5f9; transform: translateY(-1px); }
        .tool-btn:active { transform: translateY(0); }
        
        .btn-bold { color: #1e293b; }
        .btn-primary { color: #165DFF; background-color: #eff6ff; border-color: #dbeafe; }
        .btn-red { color: #ef4444; background-color: #fef2f2; border-color: #fee2e2; }

    </style>
</head>
<body>

    <div class="bg-white border-b border-gray-200 px-6 py-4 flex flex-wrap gap-4 items-center shadow-sm shrink-0 z-10">
        <h1 class="text-xl font-bold text-gray-700 mr-4"><i class="fa fa-cogs"></i> ç®€å†åå°</h1>
        
        <div class="flex items-center gap-2 bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-200">
            <i class="fa fa-github text-gray-500"></i>
            <input type="text" id="gh_owner" placeholder="Username" class="bg-transparent border-none focus:outline-none text-sm w-24">
            <span class="text-gray-300">/</span>
            <input type="text" id="gh_repo" placeholder="Repo" class="bg-transparent border-none focus:outline-none text-sm w-32">
        </div>

        <div class="flex items-center gap-2 bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-200 flex-1 max-w-xs">
            <i class="fa fa-key text-gray-500"></i>
            <input type="password" id="gh_token" placeholder="GitHub Token (ghp_...)" class="bg-transparent border-none focus:outline-none text-sm w-full">
        </div>

        <button onclick="fetchData()" class="bg-gray-700 hover:bg-gray-800 text-white px-5 py-2 rounded-lg text-sm font-medium transition shadow-sm ml-auto">
            <i class="fa fa-download"></i> è¯»å–æ•°æ®
        </button>
        <button onclick="commitChanges()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg text-sm font-medium transition shadow-sm shadow-blue-200">
            <i class="fa fa-save"></i> ä¿å­˜ä¿®æ”¹
        </button>
        <div id="status" class="text-sm font-medium animate-pulse hidden"></div>
    </div>

    <div class="flex flex-1 overflow-hidden">
        <div class="w-64 bg-white border-r border-gray-200 overflow-y-auto hidden md:block" id="sidebar">
            <div class="p-4 text-xs font-bold text-gray-400 uppercase tracking-wider">Navigation</div>
            <div id="nav-links" class="space-y-1 px-2 pb-4"></div>
        </div>

        <div class="flex-1 overflow-y-auto p-8 relative" id="main-content">
            <div id="editor-container" class="max-w-4xl mx-auto space-y-8">
                <div class="text-center text-gray-400 py-20">
                    <i class="fa fa-inbox text-4xl mb-4 opacity-50"></i>
                    <p>è¯·è¾“å…¥ GitHub ä¿¡æ¯å¹¶ç‚¹å‡»â€œè¯»å–æ•°æ®â€å¼€å§‹ç¼–è¾‘</p>
                </div>
            </div>
        </div>
    </div>

    <div id="toolbar" class="hidden">
        <span class="text-xs text-gray-400 mr-2 select-none">é€‰ä¸­æ–‡å­—ç‚¹å‡»:</span>
        <button class="tool-btn btn-bold" onclick="insertTag('<strong>', '</strong>')" title="åŠ ç²—">
            <i class="fa fa-bold"></i> ç²—ä½“
        </button>
        <button class="tool-btn btn-primary" onclick="insertTag('<span class=\'text-primary font-bold\'>', '</span>')" title="ä¸»è‰²é«˜äº®">
            <i class="fa fa-paint-brush"></i> é‡ç‚¹è“
        </button>
        <button class="tool-btn btn-red" onclick="insertTag('<span class=\'text-red-500 font-bold\'>', '</span>')" title="è­¦å‘Šçº¢">
            <i class="fa fa-exclamation-circle"></i> è­¦å‘Šçº¢
        </button>
        <div class="w-px h-4 bg-gray-300 mx-1"></div>
        <button class="tool-btn" onclick="insertTag('<br>', '')" title="æ’å…¥æ¢è¡Œ">
            <i class="fa fa-level-down fa-rotate-90"></i> æ¢è¡Œ
        </button>
    </div>

    <script>
        let appData = {};
        let fileSha = "";
        let currentActiveInput = null; // è®°å½•å½“å‰è·å¾—ç„¦ç‚¹çš„è¾“å…¥æ¡†

        // ç›‘å¬ç„¦ç‚¹ï¼Œæ˜¾ç¤º/éšè—å·¥å…·æ 
        document.addEventListener('focusin', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                currentActiveInput = e.target;
                document.getElementById('toolbar').classList.remove('hidden');
                document.getElementById('toolbar').classList.add('flex');
            }
        });

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæ’å…¥æ ‡ç­¾ ---
        function insertTag(startTag, endTag) {
            const el = currentActiveInput;
            if (!el) {
                alert("è¯·å…ˆç‚¹å‡»ä¸€ä¸ªè¾“å…¥æ¡†ï¼");
                return;
            }

            const start = el.selectionStart;
            const end = el.selectionEnd;
            const text = el.value;
            const selectedText = text.substring(start, end);

            // å¦‚æœæ²¡æœ‰é€‰ä¸­æ–‡æœ¬ï¼Œä¸”ä¸æ˜¯æ’å…¥æ¢è¡Œç¬¦ç­‰å•æ ‡ç­¾
            if (start === end && endTag !== '') {
                // å¯é€‰ï¼šå¦‚æœæ²¡æœ‰é€‰ä¸­æ–‡æœ¬ï¼Œç›´æ¥æ’å…¥æ ‡ç­¾å…‰æ ‡æ”¾ä¸­é—´
                // è¿™é‡Œæˆ‘ä»¬ç®€å•å¤„ç†ï¼Œç›´æ¥æ’å…¥ç©ºæ ‡ç­¾
            }

            const replacement = startTag + selectedText + endTag;
            el.value = text.substring(0, start) + replacement + text.substring(end);

            // æ¢å¤å…‰æ ‡ä½ç½®å¹¶é€‰ä¸­æ–°æ’å…¥çš„å†…å®¹ï¼ˆæˆ–æ”¾åœ¨æœ«å°¾ï¼‰
            el.selectionStart = start;
            el.selectionEnd = start + replacement.length;
            el.focus();

            // è§¦å‘ input äº‹ä»¶ä»¥æ›´æ–° appData
            el.dispatchEvent(new Event('input', { bubbles: true }));
        }

        // --- åˆå§‹åŒ– ---
        window.onload = () => {
            if(localStorage.getItem('gh_token')) {
                document.getElementById('gh_owner').value = localStorage.getItem('gh_owner');
                document.getElementById('gh_repo').value = localStorage.getItem('gh_repo');
                document.getElementById('gh_token').value = localStorage.getItem('gh_token');
            }
        };

        function updateStatus(msg, colorClass) {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.className = `text-sm font-medium ${colorClass}`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        }

        function setLoading(b) {
            document.body.style.cursor = b ? 'wait' : 'default';
        }

        // --- è¯»å–æ•°æ® ---
        async function fetchData() {
            setLoading(true);
            updateStatus("Loading...", "text-gray-500");
            try {
                const owner = document.getElementById('gh_owner').value;
                const repo = document.getElementById('gh_repo').value;
                const token = document.getElementById('gh_token').value;
                
                if(!owner || !repo || !token) throw new Error("Please fill all GitHub fields");
                
                localStorage.setItem('gh_owner', owner);
                localStorage.setItem('gh_repo', repo);
                localStorage.setItem('gh_token', token);

                const url = `https://api.github.com/repos/${owner}/${repo}/contents/data.json`;
                const res = await fetch(url, { headers: { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json' } });
                
                if(!res.ok) throw new Error("Fetch failed: " + res.status);
                
                const json = await res.json();
                fileSha = json.sha;
                const content = decodeURIComponent(escape(window.atob(json.content)));
                appData = JSON.parse(content);
                
                renderEditor();
                updateStatus("Loaded", "text-green-600");
                document.getElementById('toolbar').classList.add('hidden'); // åˆå§‹åŠ è½½éšè—å·¥å…·æ 
            } catch(e) {
                alert(e.message);
                updateStatus("Error", "text-red-600");
            } finally { setLoading(false); }
        }

        // --- æ¸²æŸ“ç¼–è¾‘å™¨ ---
        function renderEditor() {
            const container = document.getElementById('editor-container');
            const nav = document.getElementById('nav-links');
            container.innerHTML = '';
            nav.innerHTML = '';

            // åˆ›å»ºä¸¤ä¸ªå¤§æ ‡ç­¾é¡µï¼šä¸­æ–‡ / è‹±æ–‡
            const langs = ['zh', 'en'];
            
            langs.forEach(lang => {
                // å¯¼èˆªå¤´
                const navHeader = document.createElement('div');
                navHeader.className = "px-3 py-2 mt-4 text-xs font-bold text-gray-500 uppercase";
                navHeader.textContent = lang === 'zh' ? 'ğŸ‡¨ğŸ‡³ Chinese (ä¸­æ–‡)' : 'ğŸ‡ºğŸ‡¸ English (è‹±æ–‡)';
                nav.appendChild(navHeader);

                const langSection = document.createElement('div');
                langSection.className = "bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-8";
                langSection.innerHTML = `<div class="bg-gray-50 px-6 py-4 border-b border-gray-200 font-bold text-lg flex items-center gap-2"><span class="w-2 h-6 bg-${lang==='zh'?'blue':'green'}-500 rounded-full"></span>${lang === 'zh' ? 'ä¸­æ–‡ç®€å†æ•°æ® (data.zh)' : 'è‹±æ–‡ç®€å†æ•°æ® (data.en)'}</div>`;
                
                const contentBox = document.createElement('div');
                contentBox.className = "p-6 space-y-8";

                // éå† JSON é¡¶å±‚ (basic_info, ui, profile...)
                for (let key in appData[lang]) {
                    // å¯¼èˆªé“¾æ¥
                    const navItem = document.createElement('button');
                    navItem.className = "w-full text-left px-3 py-2 text-sm text-gray-600 hover:bg-blue-50 hover:text-blue-600 rounded transition truncate";
                    navItem.innerHTML = `<i class="fa fa-angle-right mr-2 text-xs"></i>${key}`;
                    navItem.onclick = () => document.getElementById(`section-${lang}-${key}`).scrollIntoView({behavior: 'smooth', block: 'start'});
                    nav.appendChild(navItem);

                    // å†…å®¹å—
                    const section = document.createElement('div');
                    section.id = `section-${lang}-${key}`;
                    section.className = "border-b border-gray-100 pb-8 last:border-0";
                    
                    const title = document.createElement('h3');
                    title.className = "text-md font-bold text-gray-800 mb-4 flex items-center gap-2 uppercase tracking-wide";
                    title.innerHTML = `<i class="fa fa-folder-open text-blue-400"></i> ${key}`;
                    section.appendChild(title);

                    // é€’å½’ç”Ÿæˆè¡¨å•
                    section.appendChild(generateForm(appData[lang][key], [lang, key]));
                    contentBox.appendChild(section);
                }
                
                langSection.appendChild(contentBox);
                container.appendChild(langSection);
            });
        }

        // --- é€’å½’ç”Ÿæˆè¡¨å• (æ ¸å¿ƒé€»è¾‘) ---
        function generateForm(data, path) {
            const wrapper = document.createElement('div');
            wrapper.className = "space-y-4 pl-4 border-l-2 border-gray-100";

            if (typeof data === 'string' || typeof data === 'number') {
                const input = document.createElement(data.length > 60 ? 'textarea' : 'input');
                input.className = "json-input";
                if(data.length > 60) input.rows = 3;
                input.value = data;
                
                // ç»‘å®šäº‹ä»¶ï¼šä¿®æ”¹æ—¶æ›´æ–° appData
                input.oninput = (e) => {
                    let ref = appData;
                    for(let i=0; i<path.length-1; i++) ref = ref[path[i]];
                    ref[path[path.length-1]] = e.target.value;
                };

                return input;
            } 
            else if (Array.isArray(data)) {
                data.forEach((item, idx) => {
                    const itemBox = document.createElement('div');
                    itemBox.className = "bg-gray-50 p-4 rounded-lg border border-gray-200 relative group";
                    
                    const label = document.createElement('div');
                    label.className = "text-xs font-bold text-gray-400 mb-2 uppercase";
                    label.textContent = `Item ${idx + 1}`;
                    itemBox.appendChild(label);
                    
                    itemBox.appendChild(generateForm(item, [...path, idx]));
                    
                    // ç®€å•çš„åˆ é™¤æŒ‰é’®ï¼ˆå¯é€‰ï¼Œæš‚ä¸å®ç°å¤æ‚å¢åˆ ï¼‰
                    wrapper.appendChild(itemBox);
                });
            } 
            else if (typeof data === 'object' && data !== null) {
                for (let k in data) {
                    const fieldRow = document.createElement('div');
                    
                    const label = document.createElement('label');
                    label.className = "block text-sm font-medium text-gray-600 mb-1";
                    label.textContent = k;
                    
                    fieldRow.appendChild(label);
                    fieldRow.appendChild(generateForm(data[k], [...path, k]));
                    wrapper.appendChild(fieldRow);
                }
            }
            return wrapper;
        }

        // --- ä¿å­˜ ---
        async function commitChanges() {
            if (!fileSha && !confirm("æœªæ£€æµ‹åˆ°æ–‡ä»¶SHAï¼ˆå¯èƒ½æ˜¯æœ¬åœ°é¢„è§ˆæ¨¡å¼ï¼‰ï¼Œä¿å­˜å¯èƒ½ä¼šå¤±è´¥ã€‚ç»§ç»­ï¼Ÿ")) return;
            
            updateStatus("Saving to GitHub...", "text-blue-600");
            setLoading(true);
            try {
                const owner = document.getElementById('gh_owner').value;
                const repo = document.getElementById('gh_repo').value;
                const token = document.getElementById('gh_token').value;
                
                const content = window.btoa(unescape(encodeURIComponent(JSON.stringify(appData, null, 2))));
                const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/data.json`, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: "Update via Admin V9 Toolbar", content, sha: fileSha })
                });
                
                if(!res.ok) throw new Error((await res.json()).message);
                const json = await res.json();
                fileSha = json.content.sha;
                updateStatus("âœ… Saved Successfully!", "text-green-600");
            } catch(e) {
                alert(e.message);
                updateStatus("âŒ Save Failed", "text-red-600");
            } finally { setLoading(false); }
        }
    </script>
</body>
</html>
